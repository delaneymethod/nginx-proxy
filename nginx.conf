worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 65535;
    multi_accept on;
    use epoll;
}

worker_rlimit_nofile 65535;

http {
    open_file_cache max=1000 inactive=20s;
	open_file_cache_valid 30s;
	open_file_cache_min_uses 5;
	open_file_cache_errors off;

	##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    send_timeout 150;
    types_hash_max_size 2048;
    # server_tokens off;
    
    # server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/www/html/storage/logs/nginx-access.log;
	error_log /var/www/html/storage/logs/nginx-error.log;

    upstream app {
        server nginx_phpfpm:8080;
    }

    server {
        listen 80 default_server;
        listen [::]:80 default_server ipv6only=on;

        location / {
            rewrite ^ https://$host$request_uri? permanent;
        }
    }

    server {
        client_max_body_size 600m;
        client_header_buffer_size 1k;
        client_body_buffer_size 256k;
        large_client_header_buffers 4 16k;

        listen 443 ssl;
        listen [::]:443 ssl ipv6only=on;

        root /var/www/html/public;

        charset utf-8;

        server_name _;

        # Force the latest IE version
        add_header "X-UA-Compatible" "IE=Edge";

        # Security headers via https://securityheaders.io
        # Submit your domain at https://hstspreload.org to be included in Chrome as HTTPS only.
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # Opt out of Google Federated Learning of Cohorts ("FLoC"). ref:(https://amifloced.org/)
        #add_header Permissions-Policy "interest-cohort=()" always;
        
        # Add Content-Security-Policy HTTP response header. Helps reduce XSS risks on
        # modern browsers by declaring what dynamic resources are allowed to load via a
        # HTTP Header.  See https://content-security-policy.com/
        # Uncomment this only if you know what you're doing; it will need tweaking
        #add_header Content-Security-Policy "default-src https: data: 'unsafe-inline' 'unsafe-eval'" always;

        # Compression

        # Enable Gzip compressed.
        gzip on;

        # Compression level (1-9).
        # 5 is a perfect compromise between size and cpu usage, offering about
        # 75% reduction for most ascii files (almost identical to level 9).
        gzip_comp_level 5;

        # Don't compress anything that's already small and unlikely to shrink much
        # if at all (the default is 20 bytes, which is bad as that usually leads to
        # larger files after gzipping).
        gzip_min_length 256;

        # Compress data even for clients that are connecting to us via proxies,
        # identified by the "Via" header (required for CloudFront).
        gzip_proxied any;

        # Tell proxies to cache both the gzipped and regular version of a resource
        # whenever the client's Accept-Encoding capabilities header varies;
        # Avoids the issue where a non-gzip capable client (which is extremely rare
        # today) would display gibberish if their proxy gave them the gzipped version.
        gzip_vary on;

        # Compress all output labeled with one of the following MIME-types.
        gzip_types
            application/atom+xml
            application/javascript
            application/json
            application/ld+json
            application/manifest+json
            application/rss+xml
            application/vnd.geo+json
            application/vnd.ms-fontobject
            application/x-font-ttf
            application/x-web-app-manifest+json
            application/xhtml+xml
            application/xml
            font/opentype
            image/bmp
            image/svg+xml
            image/x-icon
            text/cache-manifest
            text/css
            text/plain
            text/vcard
            text/vnd.rim.location.xloc
            text/vtt
            text/x-component
            text/x-cross-domain-policy;
            # text/html is always compressed by HttpGzipModule

        # This should be turned on if you are going to have pre-compressed copies (.gz) of
        # static files available. If not it should be left off as it will cause extra I/O
        # for the check. It is best if you enable this in a location{} block for
        # a specific directory, or on an individual server{} level.
        # gzip_static on;

        ssl_certificate /var/www/html/server.crt;
        ssl_certificate_key /var/www/html/server.key;

        ssl_session_cache builtin:1000 shared:SSL:10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
        ssl_prefer_server_ciphers on;

        resolver 8.8.8.8 8.8.4.4;

        location / {
            proxy_pass http://app;
            proxy_pass_header Set-Cookie;
            proxy_set_header Host $http_host;
            proxy_set_header Cookie $http_cookie;  
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Accept-Encoding '';
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header Referer $http_referer;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_ignore_headers Cache-Control Expires;
            proxy_buffer_size 128k;
            proxy_buffers 256 16k;
            proxy_redirect off;
            proxy_hide_header Vary;
            proxy_intercept_errors on;
            proxy_buffering off;
            proxy_busy_buffers_size 256k;
            proxy_temp_file_write_size 256k;
            proxy_max_temp_file_size 0;
            proxy_connect_timeout 600;
            proxy_read_timeout 600;
            proxy_send_timeout 600;
            proxy_http_version 1.1;
        }
    }
}
